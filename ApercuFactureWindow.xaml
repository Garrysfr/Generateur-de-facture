<Window x:Class="GenerateurFactures.ApercuFactureWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:GenerateurFactures"
        Title="Aperçu de la facture"
        Height="800"
        Width="900"
        Background="#F5F5F5"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <local:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Couleurs -->
        <SolidColorBrush x:Key="PrimaryBrush" Color="#2196F3"/>
        <SolidColorBrush x:Key="SecondaryBrush" Color="#FFC107"/>
        <SolidColorBrush x:Key="SurfaceBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextPrimaryBrush" Color="#212121"/>
        <SolidColorBrush x:Key="TextSecondaryBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#E0E0E0"/>

        <!-- Style pour les DataGrid -->
        <Style x:Key="SimpleDataGrid" TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E0E0E0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
            <Setter Property="RowHeaderWidth" Value="0"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="AlternatingRowBackground" Value="#FAFAFA"/>
        </Style>

        <!-- Style pour les boutons -->
        <Style x:Key="ModernButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#1976D2"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#1565C0"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0"
                   Text="Aperçu de la facture"
                   FontSize="24"
                   FontWeight="Bold"
                   Foreground="{StaticResource TextPrimaryBrush}"
                   Margin="0,0,0,20"/>

        <!-- Preview Area -->
        <Border Grid.Row="1"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="20"
                Margin="0,0,0,20">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>

                    <!-- En-tête facture -->
                    <Grid Margin="0,0,0,30">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Informations entreprise -->
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{Binding Facture.Entreprise.Nom}"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource TextPrimaryBrush}"/>
                            <TextBlock Text="{Binding Facture.Entreprise.Adresse}"
                                       FontSize="12"
                                       Foreground="{StaticResource TextSecondaryBrush}"/>
                            <TextBlock FontSize="12"
                                       Foreground="{StaticResource TextSecondaryBrush}">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0} {1}">
                                        <Binding Path="Facture.Entreprise.CodePostal"/>
                                        <Binding Path="Facture.Entreprise.Ville"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock Text="{Binding Facture.Entreprise.Siret, StringFormat='SIRET: {0}'}"
                                       FontSize="10"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       Visibility="{Binding Facture.Entreprise.Siret, Converter={StaticResource StringToVisibilityConverter}}"/>
                            <TextBlock Text="{Binding Facture.Entreprise.Email, StringFormat='Email: {0}'}"
                                       FontSize="10"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       Visibility="{Binding Facture.Entreprise.Email, Converter={StaticResource StringToVisibilityConverter}}"/>
                            <TextBlock Text="{Binding Facture.Entreprise.Telephone, StringFormat='Tél: {0}'}"
                                       FontSize="10"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       Visibility="{Binding Facture.Entreprise.Telephone, Converter={StaticResource StringToVisibilityConverter}}"/>
                        </StackPanel>

                        <!-- Informations facture -->
                        <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                            <TextBlock Text="FACTURE"
                                       FontSize="24"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource PrimaryBrush}"
                                       HorizontalAlignment="Right"/>
                            <TextBlock Text="{Binding Facture.Numero, StringFormat='N° {0}'}"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource TextPrimaryBrush}"
                                       HorizontalAlignment="Right"/>
                            <TextBlock Text="{Binding Facture.Date, StringFormat='Date: {0:dd/MM/yyyy}'}"
                                       FontSize="12"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       HorizontalAlignment="Right"/>
                        </StackPanel>
                    </Grid>

                    <!-- Informations client -->
                    <StackPanel Margin="0,0,0,30">
                        <TextBlock Text="Facturé à :"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="0,0,0,10"/>
                        <TextBlock Text="{Binding Facture.Client.Nom}"
                                   FontSize="12"
                                   FontWeight="Medium"
                                   Foreground="{StaticResource TextPrimaryBrush}"/>
                        <TextBlock Text="{Binding Facture.Client.Adresse}"
                                   FontSize="12"
                                   Foreground="{StaticResource TextSecondaryBrush}"/>
                        <TextBlock FontSize="12"
                                   Foreground="{StaticResource TextSecondaryBrush}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} {1}">
                                    <Binding Path="Facture.Client.CodePostal"/>
                                    <Binding Path="Facture.Client.Ville"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                        <TextBlock Text="{Binding Facture.Client.Email, StringFormat='Email: {0}'}"
                                   FontSize="12"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   Visibility="{Binding Facture.Client.Email, Converter={StaticResource StringToVisibilityConverter}}"/>
                    </StackPanel>

                    <!-- Tableau des produits -->
                    <Border BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1"
                            Margin="0,0,0,20">
                        <DataGrid ItemsSource="{Binding Facture.Produits}"
                                  Style="{StaticResource SimpleDataGrid}"
                                  IsReadOnly="True"
                                  HeadersVisibility="Column"
                                  SelectionMode="Single"
                                  IsEnabled="False">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Produit"
                                                    Binding="{Binding Nom}"
                                                    Width="3*"/>
                                <DataGridTextColumn Header="Prix unitaire"
                                                    Binding="{Binding Prix, StringFormat='C'}"
                                                    Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Quantité"
                                                    Binding="{Binding Quantite}"
                                                    Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Total"
                                                    Binding="{Binding Total, StringFormat='C'}"
                                                    Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>

                    <!-- Récapitulatif -->
                    <Grid HorizontalAlignment="Right" Width="300">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto" x:Name="ReductionRow"/>
                            <RowDefinition Height="Auto" x:Name="SousTotalRow"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Total HT :"
                                   FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,5"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Facture.TotalHT, StringFormat={}{0:C}}"
                                   FontSize="12" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,5"/>

                        <!-- Réduction (visible seulement si > 0) -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Réduction :"
                                   FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,5"
                                   Visibility="{Binding ShowReduction, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Facture.Reduction, StringFormat=-{0:C}}"
                                   FontSize="12" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,5"
                                   Visibility="{Binding ShowReduction, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <!-- Sous-total (visible seulement si réduction > 0) -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Sous-total :"
                                   FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,5"
                                   Visibility="{Binding ShowReduction, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Facture.SousTotal, StringFormat={}{0:C}}"
                                   FontSize="12" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,5"
                                   Visibility="{Binding ShowReduction, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="{Binding Facture.TauxTva, StringFormat='TVA ({0:N1}%) :'}"
                                   FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,5"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Facture.MontantTva, StringFormat={}{0:C}}"
                                   FontSize="12" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,5"/>

                        <Rectangle Grid.Row="4" Grid.ColumnSpan="2" Height="1" Fill="{StaticResource BorderBrush}" Margin="0,10"/>

                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Total TTC :"
                                   FontSize="16" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,5"/>
                        <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding Facture.TotalTTC, StringFormat={}{0:C}}"
                                   FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" HorizontalAlignment="Right" Margin="0,5"/>
                    </Grid>

                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Footer buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Content="Imprimer"
                    Style="{StaticResource ModernButton}"
                    Background="{StaticResource SecondaryBrush}"
                    Command="{Binding ImprimerCommand}"
                    Margin="0,0,10,0"
                    Padding="20,10"/>
            <Button Content="Télécharger PDF"
                    Style="{StaticResource ModernButton}"
                    Command="{Binding TelechargerCommand}"
                    Margin="0,0,10,0"
                    Padding="20,10"/>
            <Button Content="Fermer"
                    Style="{StaticResource ModernButton}"
                    Background="Gray"
                    Click="Fermer_Click"
                    Padding="20,10"/>
        </StackPanel>
    </Grid>
</Window>